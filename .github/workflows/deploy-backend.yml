name: Deploy Backend to AWS Lambda

# 触发条件：当 backend/ 目录下的文件有变更时触发
on:
  push:
    branches:
      - master # 主分支
      - main # 如果使用 main 分支
    paths:
      - "backend/**" # 只监听 backend 目录的变更
      - ".github/workflows/deploy-backend.yml" # 工作流文件本身变更也触发

  # 也可以手动触发（在 GitHub Actions 页面点击 "Run workflow"）
  workflow_dispatch:

# 环境变量（从 GitHub Secrets 读取）
env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REPO_NAME: gratitude-diary
  LAMBDA_FUNCTION_NAME: gratitude-diary-api

jobs:
  deploy:
    name: Build and Deploy to Lambda
    runs-on: ubuntu-latest # 使用 Ubuntu 虚拟机运行

    steps:
      # 步骤 1: 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤 2: 配置 AWS 凭证
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 步骤 3: 登录到 Amazon ECR
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 步骤 4: 设置 QEMU（用于跨平台构建 arm64）
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 步骤 5: 设置 Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 步骤 6: 构建并推送 arm64 镜像（Docker V2 schema）
      - name: Build and push Docker image (arm64)
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          # 使用 buildx 构建 arm64 镜像并直接推送到 ECR
          # --platform linux/arm64: 指定目标架构为 ARM64（与 Lambda arm64 架构一致）
          # --push: 直接推送到 registry（跨平台构建必须使用 --push，不能 --load）
          # --provenance=false --sbom=false: 禁用 OCI 相关特性，确保使用 Docker V2 schema（Lambda 要求）
          docker buildx build \
            --platform linux/arm64 \
            --push \
            --provenance=false \
            --sbom=false \
            -t $ECR_REGISTRY/${{ env.ECR_REPO_NAME }}:latest \
            backend

      # 步骤 7: 更新 Lambda 函数
      - name: Update Lambda function
        run: |
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --image-uri ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO_NAME }}:latest \
            --region ${{ env.AWS_REGION }}

      # 步骤 8: 等待 Lambda 更新完成
      - name: Wait for Lambda update
        run: |
          aws lambda wait function-updated \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }}

      # 步骤 9: 部署成功通知（可选）
      - name: Deployment success
        run: |
          echo "✅ 部署成功！"
          echo "Lambda 函数: ${{ env.LAMBDA_FUNCTION_NAME }}"
          echo "镜像: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO_NAME }}:latest"
